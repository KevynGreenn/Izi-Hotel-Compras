<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Izi Hotel - Requisição</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="logo.png">
</head>

<body>
    <main class="card">
        <img src="logo.png" alt="Logo Izi Hotel" class="logo">
        <div id="form-wrapper">
            <div class="form-container">
                <label for="nome">Nome Completo</label>
                <input type="text" id="nome" placeholder="Seu nome aqui">
                <label for="email">Seu E-mail (Opcional)</label>
                <input type="email" id="email" placeholder="seu.email@exemplo.com">
                <label for="telefone">Telefone (WhatsApp)</label>
                <input type="text" id="telefone" placeholder="(XX) XXXXX-XXXX">
                <label for="descricao">Descrição detalhada da compra</label>
                <textarea id="descricao" rows="5" placeholder="Ex: 10 caixas de caneta azul..."></textarea>
                <p class="aviso"><strong>Atenção:</strong> Por favor, seja o mais detalhado possível.</p>
                <label for="centro-custo">Centro de Custo</label>
                <input type="text" id="centro-custo" placeholder="Ex: Izi Express">
                <label for="valor">Valor do Produto (R$)</label>
                <input type="text" id="valor" placeholder="Ex: 150,00">
                <label for="data-pagamento">Data do Pagamento</label>
                <input type="date" id="data-pagamento">
                <label for="pagamento">Opção de Pagamento</label>
                <select id="pagamento">
                    <option value="Cartão">Cartão</option>
                    <option value="Faturado">Faturado</option>
                    <option value="Pix">Pix</option>
                </select>
                <div id="pix-field" class="hidden">
                    <label for="pix">PIX do Fornecedor</label>
                    <input type="text" id="pix" placeholder="Chave PIX do fornecedor">
                    <label for="fornecedor">Nome do Fornecedor</label>
                    <input type="text" id="fornecedor" placeholder="Nome do fornecedor">
                </div>
                <button class="btn" id="submit-btn">
                    <span class="btn-text">Enviar Requisição</span>
                    <span class="spinner hidden"></span>
                </button>
            </div>
            <a href="index.html" class="back-link">Voltar para a Home</a>
        </div>
        <div id="confirmation-message" class="hidden">
            <div class="success-animation">
                <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" />
                    <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8" />
                </svg>
            </div>
            <h2>Requisição Pronta!</h2>
            <p>Sua mensagem está sendo aberta no WhatsApp para envio. Após enviar, pode fechar a aba.</p>
            <a href="index.html" class="btn">Voltar para a Home</a>
        </div>
    </main>
    <script src="https://unpkg.com/imask"></script>
    <script>
        const formWrapper = document.getElementById('form-wrapper');
        const confirmationMessage = document.getElementById('confirmation-message');
        const submitBtn = document.getElementById('submit-btn');
        const pagamentoInput = document.getElementById('pagamento');
        const pixField = document.getElementById('pix-field');

        pagamentoInput.addEventListener('change', () => {
            pixField.classList.toggle('hidden', pagamentoInput.value !== 'Pix');
        });

        submitBtn.addEventListener('click', async (event) => {
            event.preventDefault();
            const dadosRequisicao = {
                nome: document.getElementById('nome').value,
                email: document.getElementById('email').value,
                telefone: document.getElementById('telefone').value,
                descricao: document.getElementById('descricao').value,
                centroCusto: document.getElementById('centro-custo').value,
                valor: document.getElementById('valor').value.replace(/\./g, '').replace(',', '.'),
                dataPagamento: document.getElementById('data-pagamento').value,
                opcaoPagamento: document.getElementById('pagamento').value,
                pix: document.getElementById('pix').value,
                fornecedor: document.getElementById('fornecedor').value
            };

            submitBtn.disabled = true;
            document.querySelector('.btn-text').textContent = 'Gerando Link...';
            document.querySelector('.spinner').classList.remove('hidden');

            try {
                const response = await fetch('https://izi-hotel-api.onrender.com/api/requisicao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosRequisicao)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Falha ao criar a requisição no servidor.');
                }
                
                const data = await response.json();

                // --- INÍCIO DA CORREÇÃO DEFINITIVA ---

                // 1. Validação robusta dos dados da API
                if (!data.token) {
                    throw new Error('Não foi possível obter o token de aprovação da API.');
                }
                
                // 2. Define a URL base, com um fallback (plano B) para garantir que nunca falhe
                const baseUrl = data.frontend_url || 'https://kevyngreenn.github.io/izi-hotel-compras';
                const token = data.token;
                const numeroWhatsApp = "67992007055";

                // 3. Monta o link final
                const linkAprovacao = `${baseUrl}/aprovar.html?token=${token}`;
                
                // --- FIM DA CORREÇÃO ---
                
                const mensagem = `*Nova Requisição de Compra*\n\n` +
                    `*Solicitante:* ${dadosRequisicao.nome}\n` +
                    `*Descrição:* ${dadosRequisicao.descricao}\n\n` +
                    `*Link para Aprovação:*\n${linkAprovacao}`;

                const linkWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensagem)}`;

                window.open(linkWhatsApp, '_blank');
                formWrapper.classList.add('hidden');
                confirmationMessage.classList.remove('hidden');

            } catch (error) {
                console.error('Erro detalhado:', error);
                alert('Ocorreu um erro ao gerar o link: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                document.querySelector('.btn-text').textContent = 'Enviar Requisição';
                document.querySelector('.spinner').classList.add('hidden');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            IMask(document.getElementById('telefone'), { mask: [{ mask: '(00) 0000-0000' }, { mask: '(00) 00000-0000' }] });
            IMask(document.getElementById('valor'), {
                mask: Number, scale: 2, thousandsSeparator: '.', padFractionalZeros: true, normalizeZeros: true, radix: ','
            });
        });
    </script>
</body>
</html>